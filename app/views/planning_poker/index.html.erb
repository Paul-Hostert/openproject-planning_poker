<% content_for :header_tags do %>
  <style>
    .planning-setup { padding: 20px; }
    .setup-section {
      background: white;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .setup-section h3 { 
      margin-top: 0; 
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .filter-controls {
      display: flex;
      align-items: center;
      font-size: 14px;
      font-weight: normal;
    }
    .filter-checkbox {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }
    .filter-checkbox input[type="checkbox"] {
      cursor: pointer;
    }
    .story-checkbox, .member-checkbox {
      display: block;
      padding: 10px;
      margin: 5px 0;
      background: #f5f5f5;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .story-checkbox:hover, .member-checkbox:hover {
      background: #e8e8e8;
    }
    .story-checkbox input, .member-checkbox input {
      margin-right: 10px;
    }
    .story-checkbox.hidden {
      display: none !important;
    }
    .story-meta, .member-role {
      font-size: 12px;
      color: #666;
      margin-left: 25px;
    }
    .story-points-badge {
      display: inline-block;
      background: #1A67A3;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-left: 10px;
    }
    .start-button-container {
      text-align: center;
      padding: 20px;
    }
    .info-box {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .stories-counter {
      font-size: 12px;
      color: #666;
      margin-left: 10px;
    }
  </style>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const filterCheckbox = document.getElementById('hideRatedStories');
      const counterElement = document.querySelector('.stories-counter');
      const infoBox = document.querySelector('.info-box');
      
      function filterStories() {
        const storyCheckboxes = document.querySelectorAll('.story-checkbox');
        let hiddenCount = 0;
        let visibleCount = 0;
        
        storyCheckboxes.forEach(function(storyDiv) {
          // Prüfe ob Story Points Badge existiert
          const storyPointsBadge = storyDiv.querySelector('.story-points-badge');
          const hasStoryPoints = storyPointsBadge !== null;
          
          if (filterCheckbox.checked && hasStoryPoints) {
            // Bewertete Story ausblenden wenn Checkbox aktiv
            storyDiv.style.display = 'none';
            // Checkbox deselektieren
            const checkbox = storyDiv.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.checked = false;
            hiddenCount++;
          } else {
            // Story anzeigen
            storyDiv.style.display = 'block';
            visibleCount++;
            // Bei unbewerteten Stories Checkbox aktivieren
            const checkbox = storyDiv.querySelector('input[type="checkbox"]');
            if (checkbox && !hasStoryPoints) {
              checkbox.checked = true;
            }
          }
        });
        
        // Counter aktualisieren
        const totalStories = storyCheckboxes.length;
        
        if (filterCheckbox.checked && hiddenCount > 0) {
          counterElement.textContent = `(${visibleCount} unbewertete von ${totalStories} gesamt)`;
        } else {
          counterElement.textContent = `(${totalStories} gesamt)`;
        }
        
        // Info Box bleibt unverändert - zeigt immer die Gesamtstatistik
        const ratedCount = document.querySelectorAll('.story-points-badge').length;
        if (ratedCount > 0) {
          infoBox.innerHTML = totalStories + ' Work Packages gefunden. ' + ratedCount + ' davon sind bereits bewertet.';
        } else {
          infoBox.innerHTML = totalStories + ' Work Packages gefunden.';
        }
      }
      
      // Event Listener für Checkbox
      if (filterCheckbox) {
        filterCheckbox.addEventListener('change', filterStories);
        
        // Initial Filter anwenden (standardmäßig ist Checkbox angehakt)
        filterStories();
      }
    });
  </script>
<% end %>

<%= toolbar title: "Planning Poker - #{@project.name}" %>

<div class="planning-setup">
  <%= form_with url: start_session_planning_poker_index_path(@project), local: true do |f| %>

    <!-- User Stories Selection -->
    <div class="setup-section">
      <h3>
        <span>1. User Stories oder Tasks auswählen <span class="stories-counter"></span></span>
        <div class="filter-controls">
          <label class="filter-checkbox">
            <%= check_box_tag 'hideRatedStories', '1', true %>
            Nur unbewertete Stories anzeigen
          </label>
        </div>
      </h3>

      <% if @user_stories.empty? %>
        <div class="notification -warning">
          Keine offenen Work Packages gefunden. Erstelle Work Packages in diesem Projekt.
        </div>
      <% else %>
        <div class="info-box">
          <%= @user_stories.count %> Work Packages gefunden. 
          <% stories_with_points = @user_stories.select { |s| s.story_points.present? && s.story_points > 0 }.count %>
          <% if stories_with_points > 0 %>
            <%= stories_with_points %> davon sind bereits bewertet.
          <% end %>
        </div>

        <% @user_stories.each do |story| %>
          <% has_story_points = story.respond_to?(:story_points) && story.story_points.present? && story.story_points.to_i > 0 %>
          <label class="story-checkbox <%= 'has-story-points' if has_story_points %>" data-story-id="<%= story.id %>">
            <%= check_box_tag 'story_ids[]', story.id, !has_story_points %>
            <strong>#<%= story.id %></strong> - <%= story.subject %>
            <% if has_story_points %>
              <span class="story-points-badge"><%= story.story_points %> SP</span>
            <% end %>
            <div class="story-meta">
              Typ: <%= story.type&.name || 'Kein Typ' %> |
              Status: <%= story.status.name %>
              <% if story.assigned_to %>
                | Zugewiesen an: <%= story.assigned_to.name %>
              <% end %>
            </div>
          </label>
        <% end %>
      <% end %>
    </div>

    <!-- Team Members Selection -->
    <div class="setup-section">
      <h3>2. Teilnehmer auswählen:</h3>

      <% if @project_members.empty? %>
        <div class="notification -info">
          Keine Teammitglieder gefunden. Du kannst trotzdem alleine bewerten.
        </div>
      <% else %>
        <div class="info-box">
          <%= @project_members.count %> Teammitglieder gefunden.
        </div>

        <% @project_members.each do |member| %>
          <label class="member-checkbox">
            <%= check_box_tag 'participant_ids[]', member.id, true %>
            <%= member.name %>
            <div class="member-role">
              <%= member.mail %>
            </div>
          </label>
        <% end %>
      <% end %>
    </div>

    <!-- Start Button -->
    <div class="start-button-container">
      <%= f.submit "Planning Poker starten",
                   class: "button -highlight -with-icon icon-play",
                   disabled: @user_stories.empty? %>
    </div>

  <% end %>
</div>
